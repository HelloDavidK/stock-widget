<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Couleur</title>
  <style>
    body{margin:0;font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto;}
    .wrap{max-width:520px;margin:0 auto;padding:14px 12px;text-align:center;}
    .label{font-weight:700;margin:6px 0 10px;}
    select{
      width:100%; max-width:420px;
      padding:14px 14px;
      border:1px solid #ddd; border-radius:14px;
      font-size:16px; background:#fff;
      outline:none;
    }
    .badge{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 16px; border:1px solid #eee; border-radius:999px;
      margin-top:12px; font-weight:600;
      justify-content:center;
    }
    .dot{
      width:12px;height:12px;border-radius:50%;
      box-shadow:0 0 0 3px rgba(0,0,0,.04);
    }
    .imgBox{margin-top:14px; display:flex; justify-content:center;}
    .imgBox img{
      width:100%; max-width:420px;
      height:auto; border-radius:16px;
      border:1px solid #f0f0f0;
    }
    .muted{color:#666;font-size:14px;margin-top:10px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="label">Couleur</div>
    <select id="colorSelect" disabled>
      <option>Chargement...</option>
    </select>

    <div id="badge" class="badge" style="display:none;">
      <span id="dot" class="dot"></span>
      <span id="txt"></span>
    </div>

    <div class="imgBox" id="imgBox" style="display:none;">
      <img id="variantImg" alt="Visuel couleur">
    </div>

    <div id="hint" class="muted"></div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const sku = (qs.get("sku") || "").trim();
    const select = document.getElementById("colorSelect");
    const badge = document.getElementById("badge");
    const dot = document.getElementById("dot");
    const txt = document.getElementById("txt");
    const hint = document.getElementById("hint");
    const imgBox = document.getElementById("imgBox");
    const variantImg = document.getElementById("variantImg");

    if(!sku){
      select.innerHTML = <option>SKU manquant</option>;
      hint.textContent = Ajoute ?sku=TONSKU à l’URL.;
      throw new Error("SKU manquant");
    }

    // Base URL GitHub Pages (pour transformer "images/xxx.png" en URL complète)
    const base = location.origin + location.pathname.replace(/\/[^\/]*$/, "/");

    function setStock(qty){
      badge.style.display = "inline-flex";
      if(Number(qty) > 0){
        dot.style.background = "#16a34a"; // vert
        txt.textContent = "En stock";
      } else {
        dot.style.background = "#dc2626"; // rouge
        txt.textContent = "Rupture";
      }
    }

    function setImage(path){
      if(!path) { imgBox.style.display="none"; return; }
      imgBox.style.display = "flex";
      // si path est relatif (images/...), on le convertit en URL complète
      const url = path.startsWith("http") ? path : (base + path);
      variantImg.src = url;
    }

    function normalizeColorKey(s){
      return (s||"").trim().toLowerCase();
    }

    async function main(){
      // cache-buster léger (optionnel) pour voir les modifs vite
      const res = await fetch("stock.json?v=" + Date.now(), {cache:"no-store"});
      if(!res.ok) throw new Error("Impossible de charger stock.json");
      const data = await res.json();

      const variants = data[sku];
      if(!variants || !variants.length){
        select.innerHTML = <option>SKU introuvable : ${sku}</option>;
        select.disabled = true;
        hint.textContent = "Vérifie que le SKU existe dans stock.json.";
        return;
      }

      // Remplir dropdown
      select.disabled = false;
      select.innerHTML = variants
        .map(v => <option value="${String(v.color).replace(/"/g,'&quot;')}">${v.color}</option>)
        .join("");

      // Pré-sélection : 1ère couleur en stock si possible, sinon la 1ère
      let pick = variants.find(v => Number(v.qty) > 0) || variants[0];
      select.value = pick.color;

      // Appliquer UI
      setStock(pick.qty);
      setImage(pick.img);
      hint.textContent = ""; // ok

      select.addEventListener("change", () => {
        const chosen = select.value;
        const v = variants.find(x => normalizeColorKey(x.color) === normalizeColorKey(chosen)) || variants[0];
        setStock(v.qty);
        setImage(v.img);
      });
    }

    main().catch(err => {
      select.innerHTML = <option>Erreur de chargement</option>;
      select.disabled = true;
      hint.textContent = "Erreur: " + err.message;
      console.error(err);
    });
  </script>
</body>
</html>
