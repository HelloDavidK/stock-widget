<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stock Couleur</title>

  <style>
    body{
      margin:0;
      background:transparent;
      font-family:Arial,sans-serif;
      display:flex;
      justify-content:center;
      align-items:center;
    }

    .wrap{
      width:100%;
      max-width:360px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      padding:6px 0 12px;
    }

    .label{
      width:100%;
      display:flex;
      justify-content:center;
      font-size:13px;
      font-weight:600;
    }

    select{
      width:min(340px, 92vw);
      padding:9px 12px;
      border-radius:12px;
      border:1px solid #ddd;
      background:#fff;
      font-size:14px;
      outline:none;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:6px 14px;
      border-radius:999px;
      font-size:14px;
      font-weight:600;
      border:1px solid #ddd;
      background:#fff;
      white-space:nowrap;
    }

    .dot{ width:12px;height:12px;border-radius:50%; display:inline-block; }
    .in .dot{ background:#16a34a; animation:blink 1.4s infinite; }
    .out .dot{ background:#dc2626; animation:blink 1.4s infinite; }
    @keyframes blink{ 0%,100%{opacity:1} 50%{opacity:.3} }

    /* Image */
    #variantImg{
      width:min(340px, 92vw);
      max-width:340px;
      height:auto;
      border-radius:14px;
      border:1px solid #eee;
      background:#fff;
      display:none;
    }

    .note{
      width:min(340px, 92vw);
      font-size:12px;
      color:#777;
      text-align:center;
      line-height:1.35;
      display:none;
    }

    @media (max-width:480px){
      select{ font-size:13px; }
      .badge{ font-size:13px; padding:5px 12px; }
      .dot{ width:10px;height:10px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="label">Couleur</div>

    <select id="colorSel" aria-label="Couleur">
      <option>Chargement…</option>
    </select>

    <div id="badge" class="badge">Chargement…</div>

    <!-- ✅ Image variant -->
    <img id="variantImg" alt="Photo couleur" />

    <div id="note" class="note"></div>
  </div>

<script>
(() => {
  // ✅ Paramètres Google Sheet
  const SHEET_ID = "1ZzV0Lx-XrxKLek0JwPk57Pdydn7lk7_871ZFqhuk6H4";
  const GID = "0"; // onglet STOCK

  // ✅ SKU passé dans l'URL
  const params = new URLSearchParams(location.search);
  const sku = (params.get("sku") || "").trim();

  const colorSel = document.getElementById("colorSel");
  const badge = document.getElementById("badge");
  const variantImg = document.getElementById("variantImg");
  const note = document.getElementById("note");

  function setBadge(inStock){
    if(inStock){
      badge.className = "badge in";
      badge.innerHTML = <span class="dot"></span> En stock;
    }else{
      badge.className = "badge out";
      badge.innerHTML = <span class="dot"></span> Rupture;
    }
  }

  function showImage(url){
    const u = (url || "").trim();
    if(!u){
      variantImg.style.display = "none";
      return;
    }
    // Cache-buster léger (évite anciennes images en cache)
    const hasQuery = u.includes("?");
    variantImg.src = u + (hasQuery ? "&" : "?") + "v=" + Date.now();
    variantImg.style.display = "block";
  }

  function showNote(msg){
    if(!msg){
      note.style.display = "none";
      note.textContent = "";
      return;
    }
    note.style.display = "block";
    note.textContent = msg;
  }

  if(!sku){
    colorSel.innerHTML = <option>SKU manquant</option>;
    badge.textContent = "SKU manquant";
    showNote("Ajoute ?sku=TONSKU à l’URL.");
    return;
  }

  // ✅ On lit :
  // A = SKU
  // D = Couleur
  // C = Quantité
  // E = URL image
  //
  // Requête gviz : select A, D, C, E where A='...'
  const safeSku = sku.replace(/'/g, "\\'");
  const tq = encodeURIComponent(select A, D, C, E where A='${safeSku}');

  const url = https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID}&tqx=out:json&tq=${tq};

  fetch(url)
    .then(r => r.text())
    .then(txt => {
      const jsonStr = txt.substring(txt.indexOf("{"), txt.lastIndexOf("}") + 1);
      const json = JSON.parse(jsonStr);
      const rows = json.table?.rows || [];

      if(!rows.length){
        colorSel.innerHTML = <option>SKU introuvable</option>;
        badge.textContent = "SKU introuvable";
        showNote("Vérifie que le SKU (colonne A) correspond exactement (majuscules / espaces).");
        variantImg.style.display = "none";
        return;
      }

      // Dans le résultat gviz:
      // col[0] = A (SKU)
      // col[1] = D (Couleur)
      // col[2] = C (Qté)
      // col[3] = E (Image URL)
      const items = rows.map(r => ({
        color: String(r.c?.[1]?.v ?? "").trim(),
        qty: Number(r.c?.[2]?.v ?? 0),
        img: String(r.c?.[3]?.v ?? "").trim()
      })).filter(x => x.color);

      if(!items.length){
        colorSel.innerHTML = <option>Aucune couleur</option>;
        badge.textContent = "Aucune couleur";
        variantImg.style.display = "none";
        return;
      }

      // Remplir menu déroulant
      colorSel.innerHTML = "";
      items.forEach((it, idx) => {
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = it.color;          // ✅ affiche juste la couleur
        opt.dataset.qty = String(it.qty);    // qty en interne
        opt.dataset.img = it.img || "";      // img en interne
        colorSel.appendChild(opt);
      });

      // ✅ Choisir par défaut : la 1ère couleur en stock si possible
      let defaultIdx = 0;
      for(let i=0;i<items.length;i++){
        if(Number(items[i].qty) > 0){ defaultIdx = i; break; }
      }
      colorSel.selectedIndex = defaultIdx;

      // Appliquer stock + image
      setBadge(items[defaultIdx].qty > 0);
      showImage(items[defaultIdx].img);
      showNote(""); // hide

      // Changement de couleur => mise à jour stock + image
      colorSel.addEventListener("change", () => {
        const idx = colorSel.selectedIndex;
        const item = items[idx] || items[0];

        setBadge(Number(item.qty) > 0);
        showImage(item.img);
      });
    })
    .catch((e) => {
      colorSel.innerHTML = <option>Erreur</option>;
      badge.textContent = "Erreur stock";
      variantImg.style.display = "none";
      showNote("Impossible de lire la feuille (accès / publication / réseau).");
      // console.log(e);
    });
})();
</script>
</body>
</html>
