<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Couleur + Stock</title>

  <style>
    :root { --maxw: 340px; }

    body{
      margin:0;
      padding:16px 12px;
      font-family: Arial, sans-serif;
      background:#fff;
      color:#111;
    }

    .wrap{
      max-width: var(--maxw);
      margin:0 auto;
      text-align:center;
    }

    .label{
      font-weight:700;
      margin:0 0 10px 0;
    }

    select{
      width:100%;
      max-width: var(--maxw);
      padding:12px 14px;
      font-size:16px;
      border:1px solid #ddd;
      border-radius:14px;
      outline:none;
      background:#fff;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 18px;
      border-radius:999px;
      font-weight:700;
      font-size:14px;
      border:1px solid #e6e6e6;
      margin:14px auto 0 auto;
      justify-content:center;
      background:#fff;
    }

    .dot{
      width:12px;
      height:12px;
      border-radius:50%;
    }

    .in{ background:#f0fff0; }
    .in .dot{ background:#16a34a; }

    .out{ background:#fff0f0; }
    .out .dot{ background:#dc2626; }

    .imgbox{
      margin-top:14px;
      display:flex;
      justify-content:center;
    }
    .imgbox img{
      width:100%;
      max-width:280px;
      height:auto;
      border-radius:14px;
      box-shadow:0 4px 14px rgba(0,0,0,.12);
    }

    .hint{
      margin-top:10px;
      font-size:13px;
      color:#666;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="label">Couleur</div>

    <select id="colorSelect">
      <option>Chargement…</option>
    </select>

    <div id="stockBadge"></div>
    <div class="imgbox" id="imageBox"></div>

    <div class="hint" id="hint"></div>
  </div>

<script>
  // ✅ Ton lien CSV
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS2Jr9OyZIhYyaMImhx-IvAqC7EU5B-bhrTPhWdFCqWIF_MHbB-xOCJSEj2w83HFv4tbgRURV98kFht/pub?gid=0&single=true&output=csv";

  // Colonnes (index 0 = colonne A)
  const COL_SKU   = 0; // A
  const COL_QTY   = 2; // C
  const COL_COLOR = 3; // D
  const COL_IMG   = 4; // E

  const params = new URLSearchParams(location.search);
  const skuParam = (params.get("sku") || "").trim();

  const select   = document.getElementById("colorSelect");
  const badgeEl  = document.getElementById("stockBadge");
  const imageBox = document.getElementById("imageBox");
  const hintEl   = document.getElementById("hint");

  // Petit parseur CSV (gère les virgules + guillemets)
  function parseCSV(text){
    const rows = [];
    let row = [], field = "", inQuotes = false;

    for (let i=0; i<text.length; i++){
      const c = text[i];
      const next = text[i+1];

      if (c === '"' && inQuotes && next === '"'){ field += '"'; i++; continue; }
      if (c === '"'){ inQuotes = !inQuotes; continue; }

      if (!inQuotes && (c === ",")){
        row.push(field); field = ""; continue;
      }

      if (!inQuotes && (c === "\n")){
        row.push(field); rows.push(row);
        row = []; field = ""; continue;
      }

      if (c !== "\r") field += c;
    }
    if (field.length || row.length){ row.push(field); rows.push(row); }
    return rows;
  }

  function setBadge(qty){
    const isIn = qty > 0;
    badgeEl.innerHTML = `
      <div class="badge ${isIn ? "in" : "out"}">
        <span class="dot"></span>
        ${isIn ? "En stock" : "Rupture"}
      </div>
    `;
  }

  function setImage(url){
    const clean = (url || "").trim();
    if (!clean){
      imageBox.innerHTML = "";
      return;
    }
    imageBox.innerHTML = <img src="${clean}" alt="Image produit">;
  }

  async function init(){
    if (!skuParam){
      select.innerHTML = <option>SKU manquant</option>;
      hintEl.textContent = "Ajoute ?sku=TONSKU à la fin de l’URL.";
      return;
    }

    const res = await fetch(CSV_URL, { cache: "no-store" });
    const text = await res.text();
    const table = parseCSV(text);

    // On enlève la 1ère ligne si c'est un header
    const data = table.slice(1);

    // Filtre SKU (insensible à la casse)
    const skuUpper = skuParam.toUpperCase();
    const matches = data.filter(r => (r[COL_SKU] || "").trim().toUpperCase() === skuUpper);

    if (!matches.length){
      select.innerHTML = <option>Aucune couleur trouvée</option>;
      hintEl.textContent = SKU introuvable : ${skuParam};
      badgeEl.innerHTML = "";
      imageBox.innerHTML = "";
      return;
    }

    // Remplit le menu couleurs
    select.innerHTML = "";
    matches.forEach((r, idx) => {
      const color = (r[COL_COLOR] || "").trim() || Couleur ${idx+1};
      const opt = document.createElement("option");
      opt.value = String(idx);
      opt.textContent = color;
      select.appendChild(opt);
    });

    // Affiche par défaut la première ligne
    const show = (idx) => {
      const r = matches[idx];
      const qty = parseInt((r[COL_QTY] || "0").trim(), 10) || 0;
      const img = (r[COL_IMG] || "").trim();
      setBadge(qty);
      setImage(img);
    };

    show(0);

    select.addEventListener("change", () => {
      const idx = parseInt(select.value, 10) || 0;
      show(idx);
    });

    hintEl.textContent = ""; // ok
  }

  init().catch(err => {
    select.innerHTML = <option>Erreur</option>;
    hintEl.textContent = "Impossible de charger le stock (CSV).";
    console.error(err);
  });
</script>
</body>
</html>
