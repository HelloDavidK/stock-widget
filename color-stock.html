<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Couleur + Stock</title>
  <style>
    :root{
      --maxw: 520px;
      --border:#e6e6e6;
      --ok:#16a34a;
      --bad:#dc2626;
      --muted:#666;
    }
    body{
      margin:0;
      font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:#fff;
      color:#111;
    }
    .wrap{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 14px 14px 18px;
      text-align:center;
      box-sizing:border-box;
    }
    .label{
      font-weight:700;
      font-size:18px;
      margin: 6px 0 10px;
    }
    select{
      width:100%;
      max-width: 420px;
      padding: 14px 14px;
      border:1px solid var(--border);
      border-radius: 16px;
      font-size:16px;
      background:#fff;
      outline:none;
      box-sizing:border-box;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:10px 16px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:700;
      margin-top: 12px;
      user-select:none;
    }
    .dot{
      width:12px;
      height:12px;
      border-radius:50%;
      background:#9ca3af;
      box-shadow: 0 0 0 3px rgba(156,163,175,.16);
    }
    .dot.ok{ background:var(--ok); box-shadow: 0 0 0 3px rgba(22,163,74,.18); }
    .dot.bad{ background:var(--bad); box-shadow: 0 0 0 3px rgba(220,38,38,.18); }

    /* (Optionnel) clignotement du voyant — enlève la classe blink dans le JS si tu ne veux pas */
    .blink{ animation: blink 1.1s infinite; }
    @keyframes blink { 0%,50%{opacity:1} 51%,100%{opacity:.35} }

    .imgbox{
      margin-top: 14px;
      display:flex;
      justify-content:center;
    }
    .imgbox img{
      width:100%;
      max-width:420px;
      height:auto;
      border-radius: 14px;
      border:1px solid #f1f1f1;
      display:none;
    }

    .hint{
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
    }
    .err{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid #ffd0d0;
      background:#fff3f3;
      color:#b91c1c;
      font-size: 13px;
      line-height:1.35;
      text-align:left;
      white-space:pre-wrap;
      display:none;
      word-break:break-word;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="label">Couleur</div>

    <select id="colorSelect" disabled>
      <option>Chargement…</option>
    </select>

    <div class="badge" id="badge" style="display:none;">
      <span class="dot" id="dot"></span>
      <span id="statusText">—</span>
    </div>

    <div class="imgbox">
      <img id="variantImg" alt="Photo couleur" />
    </div>

    <div class="hint" id="hint"></div>
    <div class="err" id="err"></div>
  </div>

<script>
(() => {
  const select = document.getElementById("colorSelect");
  const badge  = document.getElementById("badge");
  const dot    = document.getElementById("dot");
  const status = document.getElementById("statusText");
  const img    = document.getElementById("variantImg");
  const hint   = document.getElementById("hint");
  const errBox = document.getElementById("err");

  // Base URL auto (marche même dans Google Sites)
  const BASE = new URL("./", window.location.href).href;

  const params = new URLSearchParams(window.location.search);
  const sku = (params.get("sku") || "").trim();

  function showError(msg){
    errBox.style.display = "block";
    errBox.textContent = msg;
    select.disabled = true;
    select.innerHTML = <option>Erreur</option>;
    badge.style.display = "inline-flex";
    dot.className = "dot bad";
    status.textContent = "Erreur";
    img.style.display = "none";
  }

  function setStock(qty){
    const inStock = Number(qty) > 0;
    badge.style.display = "inline-flex";
    dot.className = "dot " + (inStock ? "ok blink" : "bad blink"); // retire "blink" si tu ne veux pas clignoter
    status.textContent = inStock ? "En stock" : "Rupture";
  }

  function setImage(path){
    if(!path){
      img.style.display = "none";
      return;
    }
    // supporte soit "images/xxx.png" soit une URL complète
    const src = String(path).startsWith("http") ? String(path) : new URL(String(path).replace(/^\/+/,""), BASE).href;
    img.src = src;
    img.style.display = "block";
  }

  async function main(){
    if(!sku){
      hint.textContent = "Ajoute ?sku=TONSKU à l’URL.";
      select.innerHTML = <option>SKU manquant</option>;
      select.disabled = true;
      return;
    }

    // Cache-buster pour éviter l’ancien code/ancien JSON
    const jsonUrl = new URL("stock.json?v=" + Date.now(), BASE).href;

    let data;
    try{
      const res = await fetch(jsonUrl, { cache:"no-store" });
      if(!res.ok) throw new Error("stock.json introuvable (" + res.status + ")");
      data = await res.json();
    }catch(e){
      return showError("Impossible de charger stock.json.\n" + (e && e.message ? e.message : e));
    }

    const variants = data[sku];
    if(!variants || !Array.isArray(variants) || variants.length === 0){
      return showError("SKU introuvable dans stock.json : " + sku + "\nVérifie la clé exactement (majuscules / espaces).");
    }

    // Remplir le menu
    select.disabled = false;
    select.innerHTML = "";
    variants.forEach((v,i) => {
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = (v.color || ("Couleur " + (i+1))).trim();
      select.appendChild(opt);
    });

    function apply(i){
      const v = variants[i];
      setStock(v.qty);
      setImage(v.img);
      hint.textContent = ""; // OK
    }

    // Afficher par défaut : la 1ère couleur en stock si possible
    let idx = 0;
    for(let i=0;i<variants.length;i++){
      if(Number(variants[i].qty) > 0){ idx = i; break; }
    }
    select.value = String(idx);
    apply(idx);

    select.addEventListener("change", () => {
      const i = Number(select.value || 0);
      apply(isNaN(i) ? 0 : i);
    });
  }

  main().catch(e => showError("Erreur inattendue.\n" + e));
})();
</script>
</body>
</html>
